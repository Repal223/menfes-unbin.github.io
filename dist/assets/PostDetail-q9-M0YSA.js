import{r,g as W,f as g,a as C,j as e,d as u,h as j,i as q,k as S,m as B,e as O,q as U,o as Q,c as N,n as z,s as F,t as V,p as X,v as Y,w as Z}from"./index-DmEEzxp2.js";import{s as H}from"./clean-BY0QpW96.js";import{A as ee,a as A}from"./Skeletons-bPoLD281.js";import{f as te}from"./time-90eS6vHA.js";const se=[{key:"heart",icon:"❤️"},{key:"like",icon:"👍"},{key:"laugh",icon:"😂"},{key:"wow",icon:"😮"},{key:"sad",icon:"😢"}];function ae({postId:a}){const[s,b]=r.useState(null),[m,p]=r.useState({love:0,like:0,laugh:0,wow:0,sad:0}),[d,T]=r.useState({});r.useEffect(()=>{b(W())},[]),r.useEffect(()=>{const n=g(u,"posts",a),y=C(n,k=>{if(!k.exists())return;const o=k.data();try{(o.likes||0)>0?j(n,{love:S(o.likes||0),likes:0,liked_by:q()}).catch(()=>{}):o.liked_by&&j(n,{liked_by:q()}).catch(()=>{})}catch{}p({love:o.love??o.likes??0,like:o.like||0,laugh:o.laugh||0,wow:o.wow||0,sad:o.sad||0});const x=o.reacted_by&&s&&o.reacted_by[s]||{};T(x)});return()=>y()},[a,s]);const w=async n=>{if(!await B()||!s)return;const k=g(u,"posts",a),x=n==="heart"?"love":n,v=!!d[n];try{await j(k,{[x]:S(v?-1:1),[`reacted_by.${s}.${n}`]:!v})}catch{}};return e.jsx("div",{style:{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap",marginTop:8},children:se.map(n=>e.jsxs("button",{className:"btn",onClick:y=>{y.preventDefault(),y.stopPropagation(),w(n.key)},style:{background:d[n.key]?"#e2d6c9":"#f5f0ea"},children:[n.icon," ",n.key==="heart"?m.love:m[n.key]||0]},n.key))})}function ne({postId:a}){const[s,b]=r.useState(null),[m,p]=r.useState(""),[d,T]=r.useState([]),[w,n]=r.useState(null),[y,k]=r.useState(!1),o=O();r.useEffect(()=>{b(W()),k(localStorage.getItem("isAdmin")==="true")},[]),r.useEffect(()=>{const t=U(N(u,"posts",a,"comments"),Q("created_at","asc")),c=C(t,l=>{T(l.docs.map(h=>({id:h.id,...h.data()||{}})))});return()=>c()},[a]);const x=async t=>{if(t.preventDefault(),!await B()){o.show("Aktifkan Anonymous Sign-in di Firebase Auth","error");return}if(!s)return;const l=m.trim();if(l)try{const h=`last_comment_ts_${a}`,_=Date.now(),I=parseInt(localStorage.getItem(h)||"0",10);if(_-I<5e3)return;await z(N(u,"posts",a,"comments"),{uid:s,text:H(l.slice(0,300)),created_at:F(),parentId:w||null}),await j(g(u,"posts",a),{total_comments:S(1)}),p(""),n(null),V(),localStorage.setItem(h,String(_))}catch{}},v=r.useMemo(()=>{const t=new Map;return d.forEach(c=>{const l=c.parentId||"root";t.has(l)||t.set(l,[]),t.get(l).push(c)}),{roots:t.get("root")||[],children:c=>t.get(c)||[]}},[d]),D=async t=>{try{await Y(g(u,"posts",a,"comments",t)),await j(g(u,"posts",a),{total_comments:S(-1)})}catch{}},K=({parent:t})=>{var c;return e.jsxs("form",{onSubmit:x,style:{display:"flex",gap:8,margin:"8px 0"},children:[e.jsx("input",{placeholder:`Balas @${((c=t.uid)==null?void 0:c.slice(0,6))||"anon"}`,value:m,onChange:l=>p(l.target.value)}),e.jsx("button",{className:"btn",children:"Balas"})]})},E=({c:t,level:c=0})=>{var R,P;const l=t.reacted_by&&s&&t.reacted_by[s]||{},h=[{key:"heart",icon:"❤️"},{key:"like",icon:"👍"},{key:"laugh",icon:"😂"},{key:"wow",icon:"😮"},{key:"sad",icon:"😢"}],[_,I]=r.useState({}),G=async(i,f)=>{if(!await B()){o.show("Aktifkan Anonymous Sign-in di Firebase Auth","error");return}if(!s)return;const $=Date.now();if(_[f]&&$-_[f]<500)return;I(M=>({...M,[f]:$}));const J=g(u,"posts",a,"comments",i),L=!!l[f];try{await j(J,{[`reacted_by.${s}.${f}`]:!L,[f]:S(L?-1:1)}),X()}catch{}};return e.jsxs("div",{className:"card",style:{padding:12,marginTop:6,marginLeft:c?16:0},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx(ee,{id:t.uid,name:(R=t.uid)==null?void 0:R.slice(0,6),size:22}),e.jsx("strong",{children:((P=t.uid)==null?void 0:P.slice(0,6))||"anon"})]}),e.jsx("p",{style:{margin:0},children:t.text}),e.jsxs("div",{style:{marginTop:6,display:"flex",gap:8,alignItems:"center"},children:[e.jsx("button",{className:"btn",style:{background:"#d7ccc8",color:"#3e2723"},onClick:()=>n(t.id),children:"Balas"}),y&&e.jsx("button",{className:"btn",style:{background:"#b23a48",color:"#fff"},onClick:()=>D(t.id),children:"Hapus"}),e.jsx("button",{className:"btn",style:{background:"#e0d7d1",color:"#3e2723"},onClick:async()=>{const i=window.prompt("Alasan lapor komentar?");if(!(!i||!i.trim()))try{await z(N(u,"posts",a,"comments",t.id,"reports"),{uid:s||"anon",reason:H(i.trim()).slice(0,500),created_at:F()}),o.show("Laporan komentar terkirim")}catch{o.show("Gagal mengirim laporan","error")}},children:"Laporkan"}),e.jsx("div",{style:{display:"flex",gap:6},children:h.map(i=>e.jsxs("button",{onClick:()=>G(t.id,i.key),title:`Reaksi ${i.key}`,style:{background:l[i.key]?"#e9ded8":"#f3e5ab",border:"1px solid rgba(0,0,0,0.08)",borderRadius:8,padding:"4px 6px",cursor:"pointer"},children:[i.icon," ",e.jsx("span",{style:{fontSize:12},children:t[i.key]||0})]},i.key))})]}),w===t.id&&e.jsx(K,{parent:t}),v.children(t.id).map(i=>e.jsx(E,{c:i,level:c+1},i.id))]})};return e.jsxs("div",{className:"card",style:{marginTop:12},children:[e.jsx("h3",{style:{marginBottom:8},children:"Komentar"}),!w&&e.jsxs("form",{onSubmit:x,style:{marginBottom:8,display:"flex",gap:8},children:[e.jsx("input",{placeholder:"Tulis komentar...",value:m,onChange:t=>p(t.target.value)}),e.jsx("button",{className:"btn",children:"Kirim"})]}),e.jsxs("div",{style:{display:"grid",gap:8},children:[v.roots.map(t=>e.jsx(E,{c:t},t.id)),d.length===0&&e.jsx("div",{children:"Belum ada komentar"})]})]})}function de(){const{id:a}=Z(),[s,b]=r.useState(null);return r.useEffect(()=>{const m=g(u,"posts",a),p=C(m,d=>{b(d.exists()?{id:d.id,...d.data()}:null)});return()=>p()},[a]),s===null?e.jsxs("div",{className:"card-glow",children:[e.jsx(A,{width:"40%",height:18}),e.jsx(A,{width:"100%"}),e.jsx(A,{width:"90%"}),e.jsx(A,{width:"80%"})]}):s.deleted||s.flagged?e.jsx("div",{className:"card-glow",children:"Postingan tidak tersedia."}):e.jsxs("div",{className:"card-glow",children:[e.jsx("h2",{children:s.nama_anonim||"Anonim"}),e.jsx("p",{children:s.isi_pesan}),e.jsxs("small",{children:[s.mood," • ",s.to," • ",te(s.created_at)]}),e.jsx(ae,{postId:a}),e.jsx(ne,{postId:a})]})}export{de as default};
